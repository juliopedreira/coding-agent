# Epic 2: Config & Persistence Layer

## Functional Analysis & Design
- Provide a persistent configuration at `~/.lincona/config.toml`, created with `chmod 600` on first write.
- Resolve settings with precedence: CLI flags > environment (`OPENAI_API_KEY`) > config file > hard defaults.
- Defaults (hardcoded): `model=gpt-4.1-mini`, `reasoning_effort=medium`, `fs_mode=restricted`, `approval_policy=on-request`, `log_level=warning`.
- Persist chat sessions as JSONL under `~/.lincona/sessions/<session_id>.jsonl`, where `session_id=YYYYMMDDHHMM-<uuid4>`.
- Write plaintext per-session logs under `~/.lincona/logs/`.
- Offer helpers to list/resume/delete sessions; ensure graceful shutdown flushes pending session/log writes.

## Technical Analysis & Design
- Config file layout:
  - `[auth]`: `api_key`
  - `[model]`: `id`, `reasoning_effort`
  - `[runtime]`: `fs_mode`, `approval_policy`
  - `[logging]`: `log_level`
- Config loader:
  - Read TOML; merge with env and CLI overrides; apply defaults; return an immutable settings object.
  - Enforce file permissions on create (`600`) and warn if broader.
- Session ID generator: `strftime("%Y%m%d%H%M") + "-" + uuid4()`; sortable and unique without coordination.
- JSONL event schema (applies to session files and tool outputs):
  - Common fields: `timestamp` (ISO 8601 UTC), `event_type`, `id` (uuid4), `trace_id` (optional), `role` (`user|assistant|tool|system`), `content` (string or structured list), `metadata` (dict), `error` (nullable), `tool_name` (optional).
  - Each line is a single JSON object; writers must be append-only and crash-safe (fsync on close).
- Logging:
  - Plaintext logs with timestamp/level/component/message; rotate via size cap (truncate if >5 MB) to avoid growth.
  - Log level driven by resolved config.
- Helpers:
  - `sessions.list()` reads filenames, parses session_ids, returns metadata (mtime, size).
  - `sessions.resume(id)` opens existing JSONL, yields events, appends new ones.
  - `sessions.delete(id)` removes JSONL and matching log file (best-effort, ignore missing).
- Shutdown:
  - Register an atexit/signal handler to flush buffered JSONL and close open PTYs if any.

## Architecture
- `config` module: load/merge/validate settings; exposes `Settings` dataclass.
- `persistence` package:
  - `sessions.py`: session ID generation; append-only JSONL writer/reader; list/resume/delete helpers.
  - `logging.py`: configure stdlib logger with per-session file handler; integrates level from settings.
- Dependencies are pure Python; no external services required; paths are under user home to avoid repo writes.

## Implementation Steps (sequential checklist)
- [x] Create `Settings` dataclass with defaults and validation for enums (`fs_mode`, `approval_policy`, `log_level`).
- [x] Implement TOML loader/merger with precedence (CLI > env > config > defaults) and permission check (`chmod 600` on create).
- [ ] Add config serialization back to TOML for future `lincona config` commands (optional).
- [ ] Implement session ID generator (`YYYYMMDDHHMM-uuid4`).
- [ ] Build JSONL event writer/reader with schema enforcement and append-only semantics.
- [ ] Implement session list/resume/delete helpers; wire to CLI/TUI hooks.
- [ ] Implement plaintext logger setup per session with size-based truncation safeguard.
- [ ] Add graceful shutdown handler to flush JSONL/logs and close PTYs.
- [ ] Write unit tests covering precedence resolution, permission enforcement, session ID format, JSONL schema, list/resume/delete, and log truncation.
