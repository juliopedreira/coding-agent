# Epic 6: TUI Frontend (Textual/Rich)

## Functional Analysis & Design
- Deliver a Textual-based TUI for chat with streamed assistant output, tool call visibility, and runtime controls.
- Display current session state (session_id, model, reasoning_effort, fs_mode, approval_policy) in a status bar.
- Support multi-turn chat with live token streaming and tool call status updates.
- Provide a session picker to list/resume/start sessions at startup or via command.
- Support slash commands (`/newsession`, `/model`, `/reasoning`, `/approvals`, `/fsmode`, `/help`, `/quit`) with inline feedback.
- Enable keyboard-first interaction and basic mouse support (focus panes, select session entries, click buttons per Q&A decision).
- Handle truncation markers and error messages gracefully without crashing the UI.
- Graceful exit on Ctrl+C (persist session) and `/quit`.

## Technical Analysis & Design
- **Framework & structure**
  - Build with Textual (and Rich for rendering). App entrypoint `lincona tui`.
  - Main layout: vertical split with chat pane (left) and side pane (right); bottom input box.
- **Widgets**
  - Chat pane: scrollable log showing user messages, streamed assistant tokens, tool call inserts, errors; supports incremental updates.
  - Tool pane: list of tool calls with status badges (pending/running/success/fail) and truncation flags.
  - Input box: multiline, supports history (↑/↓), Shift+Enter for newline, Enter to send; shows placeholder with slash hints.
  - Status bar: shows session_id, model, reasoning_effort, fs_mode, approval_policy.
  - Session picker view: modal/overlay listing sessions (from manager), with options to resume or start new; navigable via keyboard and mouse clicks.
- **Interaction model**
  - Keyboard shortcuts: Enter send, Shift+Enter newline, Esc to blur/close overlay, Ctrl+C quit gracefully.
  - Mouse support: enable Textual mouse handling; allow clicking tool entries, session list rows, and buttons (resume/new/close).
  - Slash command parsing delegated to ConversationManager; UI shows feedback message from command result.
- **Streaming handling**
  - Consume event stream from ConversationManager/OpenAI client: render token deltas incrementally; update tool entries on start/delta/end; append final assistant message.
  - Ensure UI remains responsive by applying back-pressure-friendly queue (bounded) between stream and widgets.
- **Error & truncation display**
  - Render errors inline with clear styling; include `[truncated]` markers when output caps hit.
  - Surface validation errors from slash commands in the chat pane/system line.
- **Session lifecycle**
  - On startup: show session picker overlay; allow resume/list via manager; default to new session if none.
  - On `/newsession`: clear chat/tool panes, refresh status bar with new session_id.
  - On quit: call shutdown hooks to flush/persist.
- **Configuration reflection**
  - Status bar pulls live state from ConversationManager (`get_state()`).
  - When state changes (model/reasoning/fs_mode/approval_policy), status bar updates immediately.
- **Testing approach**
  - Component-level tests using Textual’s pilot to simulate input/keystrokes/mouse clicks.
  - Snapshot rendering of key widgets (chat line, tool entry) to ensure formatting.
  - Integration test harness with fake ConversationManager emitting scripted events.

## Architecture
- New package `lincona/tui/`:
  - `app.py`: Textual App subclass; wiring to ConversationManager.
  - `views/chat_view.py`: chat pane widget with streaming updates.
  - `views/tool_view.py`: tool call side pane.
  - `widgets/input_box.py`: input component with history and shortcuts.
  - `widgets/status_bar.py`: status display.
  - `views/session_picker.py`: overlay/modal for session selection/resume/new.
  - `events.py`: internal UI events mapping from ConversationManager events.
- Integration:
  - Consumes `ConversationManager` (Epic 5) API; subscribes to its event stream.
  - Reads config defaults via manager/state; no direct config file IO from TUI.

## Implementation Steps (sequential checklist)
[ ] Scaffold `lincona/tui/app.py` with Textual App and wiring to ConversationManager.
[ ] Implement chat pane (`views/chat_view.py`) rendering messages, streamed deltas, tool call inserts, and errors.
[ ] Implement tool pane (`views/tool_view.py`) showing tool calls with status/truncation badges.
[ ] Build input box (`widgets/input_box.py`) with multiline, history, Enter/Shift+Enter, slash hinting.
[ ] Add status bar (`widgets/status_bar.py`) reflecting session state fields.
[ ] Create session picker overlay (`views/session_picker.py`) supporting keyboard and mouse selection/resume/new session.
[ ] Handle streaming events via bounded queue to update widgets without UI lockups.
[ ] Wire slash command feedback rendering in chat pane/system line.
[ ] Add graceful shutdown handling (Ctrl+C, `/quit`) invoking manager shutdown.
[ ] Add tests using Textual pilot/fakes for keyboard + mouse flows, session picker, and streaming rendering.
[ ] Update docs (`README` or dev notes) and tick Epic 6 in `docs/mvp_00/01_PLAN.md` after implementation.

## Q&A Log
- Q1: Should the TUI support mouse interactions? **Answer:** b) Enable basic mouse support (focus panes, select session, click buttons).
